<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Petanque Match Results</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f5f7fa;
      padding: 2rem;
    }
    h2 {
      margin-top: 2rem;
      color: #333;
    }
    table {
      border-collapse: collapse;
      margin-bottom: 1rem;
      width: 100%;
      max-width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 0.5rem;
    }
    .group-block {
      margin-bottom: 3rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      padding: 1rem;
    }
    .venue {
      font-weight: bold;
      color: #0066cc;
    }
    .match-table {
      margin-top: 1rem;
      overflow-x: auto;
    }
    button {
      padding: 0.6rem 1.2rem;
      background: #0077cc;
      color: white;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 1rem;
    }
    button:hover {
      background: #005fa3;
    }
  </style>
</head>
<body>
  <h1>ðŸ“Š Petanque Group Match Results</h1>
  <div id="resultsContainer"></div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpS-kqwQDgdqiVK2kwXGB9a3B7WeJI_Iw",
      authDomain: "unimap-petanque.firebaseapp.com",
      projectId: "unimap-petanque",
      storageBucket: "unimap-petanque.appspot.com",
      messagingSenderId: "578920021890",
      appId: "1:578920021890:web:987ed2de28e7b0353c999b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const groups = ["A", "B", "C", "D", "E", "F"];

    async function loadResults() {
      const teamsSnapshot = await getDocs(collection(db, "teams"));
      const matchResults = {};
      const teamsByGroup = {};

      teamsSnapshot.forEach(doc => {
        const data = doc.data();
        const group = data.group;
        if (!teamsByGroup[group]) teamsByGroup[group] = [];
        teamsByGroup[group].push(data.teamName);
      });

      const container = document.getElementById("resultsContainer");
      container.innerHTML = "";

      for (const group of groups) {
        const teamList = (teamsByGroup[group] || []).sort();
        if (teamList.length === 0) continue;

        const resultDoc = await getDoc(doc(db, "matchResults", group));
        const resultData = resultDoc.exists() ? resultDoc.data() : { matches: {}, venue: "", time: "" };

        const block = document.createElement("div");
        block.className = "group-block";

        block.innerHTML = `
          <h2>Group ${group}</h2>
          <div class="venue">Venue: ${resultData.venue || '-'} | Time: ${resultData.time || '-'}</div>
          <div class="match-table">
            <table>
              <thead>
                <tr>
                  <th>Team</th>
                  <th>Played</th>
                  <th>Won</th>
                  <th>Lost</th>
                  <th>Points</th>
                  <th>Point +</th>
                  <th>Point -</th>
                </tr>
              </thead>
              <tbody>
                ${teamList.map(team => {
                  let played = 0, won = 0, lost = 0, pointFor = 0, pointAgainst = 0;

                  teamList.forEach(opponent => {
                    if (team === opponent) return;

                    const key1 = `${team}_vs_${opponent}`;
                    const key2 = `${opponent}_vs_${team}`;
                    let score = resultData.matches[key1] || resultData.matches[key2];

                    if (score) {
                      played++;
                      const [s1, s2] = score.split('-').map(n => parseInt(n));
                      if (resultData.matches[key2]) {
                        pointFor += s2;
                        pointAgainst += s1;
                        if (s2 > s1) won++; else lost++;
                      } else {
                        pointFor += s1;
                        pointAgainst += s2;
                        if (s1 > s2) won++; else lost++;
                      }
                    }
                  });

                  const points = won * 3; // win = 3 pts
                  return `
                    <tr>
                      <td>${team}</td>
                      <td>${played}</td>
                      <td>${won}</td>
                      <td>${lost}</td>
                      <td>${points}</td>
                      <td>${pointFor}</td>
                      <td>${pointAgainst}</td>
                    </tr>
                  `;
                }).join("")}
              </tbody>
            </table>

            <h4 style="margin-top:1rem;">Match Matrix</h4>
            <table>
              <thead>
                <tr>
                  <th></th>
                  ${teamList.map(t => `<th>${t}</th>`).join("")}
                </tr>
              </thead>
              <tbody>
                ${teamList.map(row => {
                  return `<tr>
                    <th>${row}</th>
                    ${teamList.map(col => {
                      if (row === col) return `<td style="background:#eee;"></td>`;
                      const match = resultData.matches[`${row}_vs_${col}`] || resultData.matches[`${col}_vs_${row}`] || "-";
                      return `<td>${match}</td>`;
                    }).join("")}
                  </tr>`;
                }).join("")}
              </tbody>
            </table>
          </div>
        `;

        container.appendChild(block);
      }
    }

    loadResults();
  </script>
</body>
</html>
